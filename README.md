
# 小说/剧集转 SillyTavern 世界书工具

## 项目简介

本项目可将小说、动画、漫画、短剧、连续剧等带有分段剧情的文本资源，自动切分为章节，并转化为 SillyTavern 世界书（World Book）格式 JSON，便于导入和二次开发。

**新增功能：** 现已支持 WebUI 界面，提供可视化操作体验，无需命令行即可完成转换！

### 支持特性
- 智能识别多种章节格式：
	- 中文章节（如"第一章 山边小村"、"第1章"、"第一章"、"第01章：生锈的智人"、"第1110章：明争暗斗"）
	- 支持冒号分隔（中文冒号`：`和英文冒号`:`）
	- 中回格式（如"第一回 章节名"，古典小说常用）
	- 英文章节（如"Chapter 1 The Beginning"、"Chapter 1"）
	- 数字格式（如"1. 集数标题"、"1、章节名"、"1 章节名"）
	- 括号格式（如"【第一章】标题"、"【1】标题"）
	- 卷/篇/部格式（如"第一卷 标题"）
	- 兼容中文数字/阿拉伯数字编号
	- 支持任意位数数字（如第01章、第1110章）
	- 支持行首缩进和空格
- 自动提取章节名、原始标题、编号
- 检查章节编号连续性，可选强制忽略
- 支持"下回预告"功能（可选）
- 输出标准 JSON，可直接导入 SillyTavern

## 快速开始

### 安装依赖

```bash
npm install
```

### 🌐 WebUI 使用方式（推荐）

启动 WebUI 服务器：
```bash
npm start
```

然后在浏览器中打开 `http://localhost:3000`

**WebUI 功能说明：**
- 📄 **拖拽上传**：支持拖拽 txt 文件或点击选择文件
- ⚙️ **编码选择**：UTF-8（默认）或 GBK 编码
- ✅ **强制模式**：强制忽略章节编号不连续
- 🔮 **下回预告**：启用"下回预告"功能，激活当前章节和下一章节的原文
- ⬇️ **一键下载**：转换完成后直接下载世界书 JSON 文件

**操作步骤：**
1. 上传你的小说 txt 文件
2. 选择文件编码（如有乱码可切换编码重试）
3. 根据需要勾选选项
4. 点击"开始转换"按钮
5. 等待转换完成后，点击"下载世界书"

### 💻 命令行使用方式

```bash
npm run cli 文件名.txt [-e=encoding] [-f=true] [-p=true]
```
或直接使用：
```bash
node novelProcessor.js 文件名.txt [-e=encoding] [-f=true] [-p=true]
```

**参数说明：**
- `文件名.txt`：待处理的文本文件
- `-e=encoding`：可选，文件编码，支持 `utf-8`（默认）、`gbk`
- `-f=true`：可选，强制忽略章节编号不连续（默认 false）
- `-p=true`：可选，启用"下回预告"功能（默认 false）

**示例：**
```bash
npm run cli 凡人.txt -e=gbk
npm run cli 火影忍者动画集数.txt -e=utf-8 -f=true
```

> `htmlProcessor.js` 为示例爬虫脚本，可用于爬取火影中文 wiki 剧集信息。请根据实际需求自行改写。

### 输出说明
- 生成的 JSON 文件名为 `世界书.json`（可自定义）
- 可直接导入 SillyTavern 世界书

## 注意事项
- 如章节格式特殊或未被识别，请调整正则表达式或选择合适的规则
- 大型 txt 文件建议先备份
- **头部 JSON 模板请根据实际需求自定义**，或在 SillyTavern 内添加
- WebUI 服务器默认端口为 3000，如需修改请编辑 `server.js` 中的 PORT 配置
- 项目内置了24种常见章节识别规则（exportTxtTocRule.json），覆盖了大部分网文格式

## 调试信息说明

默认情况下，WebUI 只显示简单的成功/失败消息，如 `转换成功！共处理 4739 章`。

如需查看详细的调试信息（包括规则匹配情况等），请按以下步骤取消注释：

1. **novelProcessor.js**（第9行）：
   ```javascript
   this.debugInfo = '';  // 取消此行注释
   ```

2. **novelProcessor.js**：取消所有 `this.debugInfo += ...` 的注释（约6处）

3. **server.js**（第57行）：
   ```javascript
   debug: processor.debugInfo  // 取消此行注释
   ```

4. **server.js**（第61行）：
   ```javascript
   debug: error.debugInfo || ''  // 取消此行注释
   ```

5. **public/index.html**（第405-407行）：
   ```javascript
   if (data.debug) {
       successMsg += '\n\n调试信息：\n' + data.debug;  // 取消此行注释
   }
   ```

6. **public/index.html**（第412-414行）：
   ```javascript
   if (data.debug) {
       errorMsg += '\n\n' + data.debug;  // 取消此行注释
   }
   ```

重启服务器后，转换结果将显示详细的调试信息，包括：
- 使用的规则类型
- 每个规则匹配到的章节数量
- 匹配到的章节标题示例（前5处）
- 总匹配数量和去重结果

## 常见问题

### Q: 提示"未检测到章节标记，无法分割章节"怎么办？

**A:** 可能的原因和解决方法：

1. **选择合适的规则** - WebUI提供了24种章节识别规则，包括：
   - `目录` - 标准的章节格式（第一章 标题）
   - `目录(去空白)` - 去除行首空白后匹配
   - `数字 分隔符 标题名称` - 如"1、这个就是标题"
   - `大写数字 分隔符 标题名称` - 如"一、只有前面的数字有差别"
   - `正文 标题/序号` - 如"正文 我奶常山赵子龙"
   - `Chapter/Section/Part/Episode 序号 标题` - 英文格式
   - `特殊符号 序号 标题` - 如"【第一章 后面的符号可以没有"
   - `特殊符号 标题(单个)` - 如"☆、晋江作者最喜欢的格式"
   - `章/卷 序号 标题` - 如"卷五 开源盛世"
   - `书名 括号 序号` - 如"标题后面数字有括号(12)"
   - `书名 序号` - 如"标题后面数字没有括号124"
   - `字数分割 分节阅读` - 如"分节|分页|分段阅读"

2. **检查调试信息** - 转换失败时会显示详细的调试信息，包括：
   - 尝试的规则和匹配结果
   - 每个规则匹配到的内容（前5处）
   - 总匹配数量

3. **检查文件编码** - 如果是中文乱码，尝试切换编码：
   - WebUI：选择 GBK 编码
   - 命令行：添加 `-e=gbk` 参数

4. **检查文本格式** - 打开txt文件查看：
   - 章节之间是否有空行
   - 是否有特殊字符
   - 是否使用全角/半角标点

### Q: 如何添加自定义的章节识别规则？

**A:** 编辑 `exportTxtTocRule.json` 文件，按照现有格式添加新规则：
```json
{
  "enable": true,
  "example": "示例文本",
  "id": -26,
  "name": "规则名称",
  "rule": "正则表达式",
  "serialNumber": 25
}
```
注意：
- `enable` 必须为 `true` 才会生效
- `serialNumber` 必须唯一
- `rule` 使用标准的 JavaScript 正则表达式语法

### Q: 转换后的JSON可以导入SillyTavern吗？

**A:** 可以。生成的`世界书.json`文件是标准格式，直接在SillyTavern的世界书管理中选择导入即可。

## 项目更新日志

### v1.1.0
- ✨ 新增 WebUI 可视化界面
- 🎨 现代化界面设计，支持拖拽上传
- 📱 响应式布局，支持移动端访问
- 🔧 集成文件上传 API 接口
- 📦 新增依赖：Express、Multer

### v1.0.0
- 🎉 初始版本发布
- ✅ 支持多种章节格式识别
- ✅ 命令行工具支持

## 技术栈
- **后端**：Node.js + Express
- **文件处理**：Multer + iconv-lite
- **前端**：原生 HTML/CSS/JavaScript

---

如有问题或建议，欢迎反馈！
